<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TURNİR CƏDVƏLİ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px auto;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #343a40;
      color: white;
    }
    .icon-up { color: green; }
    .icon-down { color: red; }
    .icon-same { color: gray; }
  </style>
</head>
<body>
  <h2>Cari Tur Nəticəsi</h2>
  <div style="text-align:center;">
    <button onclick="location.href='index.html'" style="margin: 20px auto; padding: 10px 25px; background-color: #000; color: #fff; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer;">ANA SƏHİFƏ</button>
  </div>

  
  <table id="currentTable">
    <thead>
      <tr>
        <th>Yer</th>
        <th>İştirakçı</th>
        <th>Düzgün</th>
        <th>Əmsallar</th>
        <th>Xal</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Ümumi Turnir Cədvəli</h2>
  <table id="overallTable">
    <thead>
      <tr>
        <th>Yer</th>
        <th>İştirakçı</th>
        <th>Ümumi Xal</th>
        <th>Yerdəyişmə</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const predictions = JSON.parse(localStorage.getItem("userPredictions") || "{}");
    const results = JSON.parse(localStorage.getItem("officialResults") || "[]");
    const participants = Object.keys(predictions).sort();
    const allHits = {};

    const matchCount = results.length;
    const matchHitCounts = Array(matchCount).fill(0);

    participants.forEach(name => {
      const userPreds = predictions[name] || [];
      userPreds.forEach((p, i) => {
        if (p === results[i]) matchHitCounts[i]++;
      });
    });

    const scores = participants.map(name => {
      const preds = predictions[name] || [];
      let correct = 0;
      const coeffs = [];

      preds.forEach((p, i) => {
        if (p === results[i]) {
          correct++;
          coeffs.push(matchHitCounts[i]);
        }
      });

      return { name, correct, coeffs: coeffs.sort((a, b) => a - b) };
    });

    scores.sort((a, b) => {
      if (b.correct !== a.correct) return b.correct - a.correct;
      const len = Math.min(a.coeffs.length, b.coeffs.length);
      for (let i = 0; i < len; i++) {
        if (a.coeffs[i] !== b.coeffs[i]) return a.coeffs[i] - b.coeffs[i];
      }
      return a.coeffs.length - b.coeffs.length;
    });

    const maxPoints = participants.length - 1;
    const currentTable = document.querySelector("#currentTable tbody");
    const pointsMap = {};
    scores.forEach((p, index) => {
      const eligible = p.correct >= 3;
      const samePlaceAsAbove = index > 0 && p.correct === scores[index - 1].correct &&
                                JSON.stringify(p.coeffs) === JSON.stringify(scores[index - 1].coeffs);

      const place = samePlaceAsAbove ? currentTable.rows[index - 1].cells[0].innerText : (index + 1) + ".";
      const row = currentTable.insertRow();
      row.insertCell().innerText = place;
      row.insertCell().innerText = p.name;
      row.insertCell().innerText = p.correct;
      row.insertCell().innerText = p.coeffs.join(", ");
      const points = eligible ? maxPoints - index : 0;
      row.insertCell().innerText = points;
      pointsMap[p.name] = points;
    });

    const oldScores = JSON.parse(localStorage.getItem("overallScores") || "{}");
    const updatedScores = {};
    participants.forEach(p => {
      const old = oldScores[p] || { points: 0, lastPlace: 99 };
      const gained = pointsMap[p] || 0;
      updatedScores[p] = {
        points: old.points + gained,
        lastPlace: 0 // temporary
      };
    });

    const ranking = Object.entries(updatedScores)
      .map(([name, data]) => ({ name, ...data }))
      .sort((a, b) => b.points - a.points);

    ranking.forEach((p, i) => {
      p.place = i + 1;
      updatedScores[p.name].lastPlace = i + 1;
    });

    localStorage.setItem("overallScores", JSON.stringify(updatedScores));

    const overallTable = document.querySelector("#overallTable tbody");
    ranking.forEach(p => {
      const row = overallTable.insertRow();
      row.insertCell().innerText = p.place + ".";
      row.insertCell().innerText = p.name;
      row.insertCell().innerText = p.points;

      const oldPlace = (oldScores[p.name] && oldScores[p.name].lastPlace) || 99;
      const icon = oldPlace > p.place ? "↑" : oldPlace < p.place ? "↓" : "→";
      const className = oldPlace > p.place ? "icon-up" : oldPlace < p.place ? "icon-down" : "icon-same";
      const iconCell = row.insertCell();
      iconCell.innerHTML = `<span class="${className}">${icon}</span>`;
    });
  </script>
</body>
</html>
